<!DOCTYPE html>
<html>
        <head>
                <title>Landmarks</title>
                <link rel="stylesheet" href="stylesheet.css" type="text/css"/>
                <h1> Landmarks  </h1>
                <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3"></script>
                <meta content="utf-8" http-equiv="encoding">

                <script type="text/javascript">

                        var myLat = 0;
                        var myLng = 0;
                        var request = new XMLHttpRequest();
                        var me = new google.maps.LatLng(myLat, myLng);
                        var map;
                        raw = "";

                        var infowindow = new google.maps.InfoWindow();

                        var myOptions = {
                                zoom: 14,
                                center: me,
                                mapTypeId: google.maps.MapTypeId.ROADMAP
                        };

                        function init(){

                                console.log("begginning of init");
                                loadMap();
                        }

                        function loadMap(){

                                if (!navigator.geolocation){
                                        console.log("NOT SUPPORTED");
                                }
                                
                                else{
                                        navigator.geolocation.getCurrentPosition(success, fail);
                                }

                                function success(position){
                                        var loc = position.coords;
                                        myLat = loc.latitude;
                                        myLng = loc.longitude;
                                        render();
                                        sendAndReceieve();

                                };

                                function fail(error){
                                        console.warn('ERROR(' + error.code + '): ' + error.message);
                                };
                        }

                        function render(){
                                console.log("render line 1");
                                me = new google.maps.LatLng(myLat, myLng);
                                
                                myOptions = {
                                        zoom: 14,
                                        center: me,
                                        mapTypeId: google.maps.MapTypeId.ROADMAP
                                };
        
                                map = new google.maps.Map(document.getElementById("the_map"), myOptions);


                                marker = new google.maps.Marker({
                                        position: me,
                                        title: "Here I Am!"
                                });

                                marker.setMap(map);

                                google.maps.event.addListener(marker, 'click', function() {
                                        infowindow.setContent(marker.title);
                                        infowindow.open(map, marker);
                                })

                                map.panTo(me);
                        }

                        function sendAndReceieve(){

                                console.log("in send and receive lat: " + myLat + " lng: " + myLng);

                                request.open("POST", "https://defense-in-derpth.herokuapp.com/sendLocation?login=MANUELA_ACEVEDO&lat=" + myLat +"&lng=" + myLng, true);

                                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                                console.log("here");

                                request.onreadystatechange = handleResponse;

                                request.send("login=MANUELA_ACEVEDO&lat=" + myLat + "&lng=" + myLng);
                        }

                        function handleResponse(){

                                console.log("in reponse handling");
                                
                                if (request.readyState == 4 && request.status == 200){
                                        result = "";
                                        raw += request.response;
                                        console.log("response was: " + raw);
                                        data = JSON.parse(raw);
                                        var markers = [];
                                        for (i = 0; i < data["people"].length; i++){
                                                currLat = data["people"][i]["lat"];
                                                currLng = data["people"][i]["lng"];

                                                currPos = new google.maps.LatLng(currLat, currLng);
                                                addPerson(currPos);
                                        }
        
                                       for (i = 0; i < data["landmarks"].length; i++){

                                                currLat = data["landmarks"][i]["geometry"]["coordinates"][1];
                                                currLng = data["landmarks"][i]["geometry"]["coordinates"][0];
                                                currPos = new google.maps.LatLng(currLat, currLng);

                                                addFeature(currPos);
                                        }
                                }
                                
                                else if (request.readyState == 4 && request.status != 200){
                                        console.log("SOMETHING WENT WRONG WITH THE REQUST");
                                }
                        }

                        function addFeature(currPos){

                                image = "https://cdn3.iconfinder.com/data/icons/location-vol-2/128/location-27-32.png";

                                var currMarker = new google.maps.Marker({
                                        position: currPos,
                                        title: data["landmarks"][i]["properties"]["Location_Name"],
                                        icon: image
                                });

                                currMarker.setMap(map);

                                google.maps.event.addListener(currMarker, 'click', function() {
                                infowindow.setContent(currMarker.title);
                                infowindow.open(map, currMarker);
                                })
                        }

                        function addPerson(currPos){
                                
                                image = "https://storage.googleapis.com/support-kms-prod/SNP_2752125_en_v0";

                                var currMarker = new google.maps.Marker({
                                        position: currPos,
                                        title: data["people"][i]["login"],
                                        icon: image,
                                        clickable: true
                                });

                                currMarker.setMap(map);

                                google.maps.event.addListener(currMarker, 'click', function() {
                                infowindow.setContent(currMarker.title);
                                infowindow.open(map, currMarker);
                                })
                        }

                </script>


        </head>

        <body onload="init()">

                <div id="the_map"></div>

                

        </body>
</html>